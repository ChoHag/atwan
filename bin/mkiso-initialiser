#!/bin/bash
set -e

if [ ! -e "$(dirname $0)"/atwan.installdirs ]; then
  echo "$(dirname $0)"/atwan.installdirs does not exist. Aborting. >&2
  exit 1
fi
source "$(dirname $0)"/atwan.installdirs
source "$at_lib"/atwan.lib

unset at_force at_work_dir at_cache_dir at_out_file at_release
unset at_search_path at_search_path_prepend at_search_path_replace
unset at_bootstrap at_bootstrap_basic at_bootstrap_extended
unset at_etc_dir at_proxy at_secret
unset at_dhcp at_hostname at_fqdn at_ip at_gateway at_dns
unset at_signkey
export at_mask=255.255.255.0

usage() {
cat <<EOF
  Usage:
    mkiso-initialiser [-f] [-w <work dir>] [-c <cache dir>] [-o <output>]
      -r <release> [(-p|-P) <search path>] [-s <root password>]
      [ (-b|-B) -t <etc dir> ] [ -h <http proxy> ] [-k <signing key id>]
      ( -D | -n <fqdn> -i <ip> [-m <netmask>] [-g <gateway>] ) -d <dns>

  Options:
    -f: Overwrite old image if it exists (force)
    -w: Working directory
	The default is that of mktemp, which is almost certainly /tmp.
    -c: Cache directory
	If set, a location to download files to. If the file already exists,
	it is used instead.
    -o: Output filename
        Default: Based on the template ./initialiser--(<fqdn>|DHCP).iso
    -r: Gold Image's OS release to create an initialiser for.
	See $at_lib/release for a list of available releases.  This MUST MATCH
	the release used to create the gold image this initialiser iso will be
	used on.
    -p: :-seperated list of paths to prepend to the release script search path.
    -P: :-seperated list of paths to use instead of the default search path.
	Relative paths are appended to the release top directory
	($at_lib/release/\$release)
    -s: Host's new root password.
    -b: Create a basic bootstrap iso.
    -B: Create an extended bootstrap iso; use the CMDB installed into /etc.
    -t: A directory which will be stored in a tar archive and extracted to
        /etc on the bootstrap server.
    -h: Host's HTTP proxy.
    -k: GPG key id to use to sign the initialiser iso.
    -D: DHCP-configured host.
	Unimplemented
    -n: Named host.
    -i: Host's IP address.
	DNS lookup is not implemented thus this parameter is required.
    -m: Host's netmask.
	Default: 255.255.255.0
	Until it is tested, short form netmasks are not supported.
    -g: Host's gateway.
	Default: Network address of host with a .1 suffix.
    -d: Host's DNS.
	A white-space separated list. Use quotes.
	Lookup from this machine's /etc/resolv.conf is not implemented.
EOF
}

while getopts 'fw:c:o:r:p:P:bBt:h:s:k:Dn:i:m:g:d:' arg; do
  case $arg in
    f) export at_force=1 ;;
    w) export at_work_dir=$OPTARG ;;
    c) export at_cache_dir=$OPTARG ;;
    o) export at_out_file=$OPTARG ;;
    r) export at_release=$OPTARG ;;
    p) export at_search_path_prepend=$OPTARG ;;
    P) export at_search_path_replace=$OPTARG ;;
    b) export at_bootstrap_basic=1 ;;
    B) export at_bootstrap_extended=1 ;;
    t) export at_etc_dir=$OPTARG ;;
    h) export at_proxy=$OPTARG ;;
    s) export at_secret=$OPTARG ;;
    k) export at_signkey=$OPTARG ;;
    D) export at_dhcp=1 ;;
    n) export at_hostname=$OPTARG ;;
    i) export at_ip=$OPTARG ;;
    m) export at_mask=$OPTARG ;;
    g) export at_gateway=$OPTARG ;;
    d) export at_dns=$OPTARG ;;
    ?)
      usage
      exit 1
      ;;
  esac
done
shift $(expr $OPTIND - 1)

check_common_arguments

if [ "$at_bootstrap_basic" -a "$at_bootstrap_extended" ]; then
  echo 'Basic (-b) and extended (-B) bootstrap ISOs are mutually incompatible.' >&2
  exit 1
elif [ "$at_bootstrap_basic" ]; then
  export at_bootstrap=basic
  echo Selected a basic bootstrap iso.
elif [ "$at_bootstrap_extended" ]; then
  export at_bootstrap=extended
  echo Selected an extended bootstrap iso.
fi

if [ "$at_bootstrap" ]; then
  if [ -z "$at_etc_dir" -o ! -d "$at_etc_dir" ]; then
    echo 'Need a directory to tar (-t) to build a bootstrap iso.' >&2
    exit 1
  fi
fi

if [ -z "$at_dhcp" -a -z "$at_hostname" ]; then
  echo 'Need to specify DHCP (-D) or named (-n) iso.' >&2
  exit 1
elif [ "$at_dhcp" -a "$at_hostname" ]; then
  echo 'Cannot specify a DHCP (-D) and named (-n) iso.' >&2
  exit 1
elif [ "$at_hostname" ]; then
  export at_network=static
  export at_fqdn=$at_hostname
  export at_domain=${at_hostname#*.}
  export at_hostname=${at_hostname%%.*}
  if [ -z "$at_domain" ]; then
    echo 'Named host must include a domain name (FQDN).' >&2
    exit 1
  fi
  if [ -z "$at_ip" ]; then
    echo DNS lookup is unimplemented. >&2
    exit 2
  fi
  if [ -z "$at_gateway" ]; then
    export at_gateway=${at_ip%.*}.1
  fi
  echo Building a named iso for $at_fqdn:
  echo \ \ FQDN: $at_fqdn \($at_hostname @ $at_domain\)
  echo \ \ IP: $at_ip
  echo \ \ Netmask: $at_mask
  echo \ \ Gateway: $at_gateway
elif [ "$at_dhcp" ]; then
  export at_network=dhcp
  echo DHCP iso is unimplemented. >&2
  exit 2
else
  echo The universe has broken logic. >&2
  exit 2
fi
echo \ \ DNS: $at_dns

if [ -z "$at_out_file" ]; then
  if [ "$at_dhcp" ]; then
    export at_out_file="initialiser--DHCP.iso"
  else
    export at_out_file="initialiser--${at_fqdn}.iso"
  fi
fi

export at_build_dir=$(mktemp ${at_work_dir:+--tmpdir="$at_work_dir"} -d)
trap 'chmod +rw -R "$at_build_dir" && rm -fr "$at_build_dir"' EXIT

steps=(
  " -variables:  Set variables."
  "1-stop-initialiser: Stop automatic initialiser (cron)."
  " -secret:     Set root password?"
  " -bootstrap:  Run bootstrap?"
  "0-network:    Configure network and HTTP proxy."
  "0-repository: Configure package repository."
  "0-cmdb:       Install and run a CMDB (eg. puppet)."
)
# proxy, secret

variables() {
  ignore=(at_bin at_lib at_search_path at_work_dir at_build_dir at_cache_dir)
  (
    for var in ${!at_*}; do
      if [[ ${ignore[@]} =~ $var ]]; then
	continue
      fi
      eval echo export $var=\\\"\$$var\\\"
      true
    done
  ) > "$at_build_dir"/autorun-variables
}

secret() {
  if [[ -z "$at_secret" ]]; then
    echo No. Root password unchanged.
    return
  fi

  run_script init 1 secret "Updating host root's password."
  push_script secret
}

bootstrap() {
  if [[ -z "$at_bootstrap" ]]; then
    echo No. Bootstrap not requested.
    return
  fi

  run_script init 1 bootstrap "Installing bootstrap functions."
}

echo Setting up new host\'s initialiser:
unset scripts
run_steps init
echo Host initialiser build complete.

cp "$at_lib"/autorun "$at_build_dir"/autorun

for script in ${scripts[@]}; do
  chmod 755 "$at_build_dir"/autorun-$script
  echo '"$at_top"'/autorun-$script
done >> "$at_build_dir"/autorun
echo Generating some random noise.
echo \# noise: $( dd if=/dev/random bs=1 count=32 | (shasum||md5sum) ) >> "$at_build_dir"/autorun
chmod 755 "$at_build_dir"/autorun

append_readme init

list=$(mktemp ${at_work_dir:+--tmpdir="$at_work_dir"})
for file in "$at_build_dir"/*; do
  if [ -f "$file" ]; then
    gpg --sign ${at_signkey:+--default-key "$at_signkey"} "$file"
    echo "${file##$at_build_dir}" >> "$list"
  else
    echo WARNING: Non-file found in build dir: "${file##$at_build_dir}" >&2
  fi
done
mv "$list" "$at_build_dir"/cd.list
gpg --sign ${at_signkey:+--default-key "$at_signkey"} "$at_build_dir"/cd.list

create_image init

