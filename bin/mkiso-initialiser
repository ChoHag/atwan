#!/bin/bash

set -e

if [ ! -e "$(dirname $0)"/atwan.installdirs ]; then
  echo "$(dirname $0)"/atwan.installdirs does not exist. Aborting. >&2
  exit 1
fi
source "$(dirname $0)"/atwan.installdirs
source "$at_bin"/atwan.lib

unset at_force at_work_dir at_cache_dir at_out_file
unset at_bootstrap at_bootstrap_pm at_bootstrap_enc
unset at_puppet_dir at_proxy at_release at_secret
unset at_dhcp at_hostname at_fqdn at_ip at_gateway at_dns
at_mask=255.255.255.0

usage() {
cat <<EOF
  Usage:
    mkiso-initialiser [-f] [-w <work dir>] [-c <cache dir>]
      [-o <output>] [ (-b|-B) -p <puppet dir> ] [ -h <http proxy> ]
      -r <release> [-s <root password>]
      ( -D | -n <fqdn> -i <ip> [-m <netmask>] [-g <gateway>] ) -d <dns>

  Options:
    -f: Overwrite old image if it exists (force)
    -w: Working directory
	The default is that of mktemp, which is almost certainly /tmp.
    -c: Cache directory
	If set, a location to download files to. If the file already exists,
	it is used instead.
    -o: Output filename
        Default: Based on the template ./initialiser--(<fqdn>|DHCP).iso
    -b: Create a puppetmaster bootstrap iso.
    -B: Create a bootstrap iso using the node's own ENC entry.
	Will not work with DHCP nodes.
    -p: Directory which will be copied to /etc/puppet on the bootstrap server.
    -h: Host's HTTP proxy.
    -r: OS release to create gold image of.
	See $at_lib/releases for a list of available releases.
	This MUST MATCH the release used to create the gold image this
	initialiser iso will be used on.
    -s: Host's new root password.
    -D: DHCP-configured host.
	Unimplemented
    -n: Named host.
    -i: Host's IP address.
	DNS lookup is not implemented thus this parameter is required.
    -m: Host's netmask.
	Default: 255.255.255.0
	Until it is tested, short form netmasks are not supported.
    -g: Host's gateway.
	Default: Network address of host with a .1 suffix.
    -d: Host's DNS.
	A white-space separated list. Use quotes.
	Lookup from this machine's /etc/resolv.conf is not implemented.
EOF
}

while getopts 'fw:c:o:bBp:h:r:s:Dn:i:m:g:d:' arg; do
  case $arg in
    f) export at_force=1 ;;
    w) export at_work_dir=$OPTARG ;;
    c) export at_cache_dir=$OPTARG ;;
    o) export at_out_file=$OPTARG ;;
    b) export at_bootstrap_pm=1 ;;
    B) export at_bootstrap_enc=1 ;;
    p) export at_puppet_dir=$OPTARG ;;
    h) export at_proxy=$OPTARG ;;
    r) export at_release=$OPTARG ;;
    s) export at_secret=$OPTARG ;;
    D) export at_dhcp=1 ;;
    n) export at_hostname=$OPTARG ;;
    i) export at_ip=$OPTARG ;;
    m) export at_mask=$OPTARG ;;
    g) export at_gateway=$OPTARG ;;
    d) export at_dns=$OPTARG ;;
    ?)
      usage
      exit 1
      ;;
  esac
done
shift $(expr $OPTIND - 1)

check_arguments

if [ "$at_bootstrap_pm" -a "$at_bootstrap_enc" ]; then
  echo 'Cannot make a puppetmaster (-b) and an ENC (-B) bootstrap iso' >&2
  exit 1
elif [ "$at_bootstrap_pm" ]; then
  export at_bootstrap=pm
  echo Selected a puppetmaster bootstrap iso.
elif [ "$at_bootstrap_enc" ]; then
  export at_bootstrap=enc
  echo Selected an ENC bootstrap iso.
fi
if [ "$at_bootstrap" ]; then
  if [ -z "$at_puppet_dir" -o ! -d "$at_puppet_dir" ]; then
    echo 'Need a puppet_dir (-p) to build a bootstrap iso.' >&2
    exit 1
  fi
fi

if [ -z "$at_dhcp" -a -z "$at_hostname" ]; then
  echo 'Need to specify DHCP (-D) or named (-n) iso.' >&2
  exit 1
elif [ "$at_dhcp" -a "$at_hostname" ]; then
  echo 'Cannot specify a DHCP (-D) and named (-n) iso.' >&2
  exit 1
elif [ "$at_hostname" ]; then
  export at_fqdn=$at_hostname
  export at_domain=${at_hostname#*.}
  export at_hostname=${at_hostname%%.*}
  if [ -z "$at_domain" ]; then
    echo 'Named host must include a domain name (FQDN).' >&2
    exit 1
  fi
  if [ -z "$at_ip" ]; then
    echo DNS lookup is unimplemented. >&2
    exit 2
  fi
  if [ -z "$at_gateway" ]; then
    at_gateway=${at_ip%.*}.1
  fi
  echo Building a named iso for $at_fqdn:
  echo \ \ FQDN: $at_fqdn \($at_hostname @ $at_domain\)
  echo \ \ IP: $at_ip
  echo \ \ Netmask: $at_mask
  echo \ \ Gateway: $at_gateway
elif [ "$at_dhcp" ]; then
  echo DHCP iso is unimplemented. >&2
  exit 2
else
  echo The universe has broken logic. >&2
  exit 2
fi
echo \ \ DNS: $at_dns

if [ -z "$at_out_file" ]; then
  if [ "$at_dhcp" ]; then
    at_out_file="initialiser--DHCP.iso"
  else
    at_out_file="initialiser--${at_fqdn}.iso"
  fi
fi

export at_build_dir=$(mktemp ${at_work_dir:+--tmpdir="$at_work_dir"} -d)
trap 'chmod +rw -R "$at_build_dir" && rm -fr "$at_build_dir"' EXIT

steps=(
  "-variables: Set variables."
  "stop-initialiser: Stop automatic initialiser (cron)."
  "-secret:    Set root password?"
  "-bootstrap: Run bootstrap?"
  "network:    Configure network and HTTP proxy."
  "puppet:     Install and run puppet."
)
# proxy, secret

unset scripts
push_script() {
  scripts=("${scripts[@]}" "$@")
}

variables() {
  (
    if [ "$at_dhcp" ]; then
      echo at_network=dhcp
    else
      echo at_network=static
    fi
    for var in at_bootstrap at_proxy  \
      at_fqdn at_hostname at_domain   \
      at_ip at_mask at_gateway at_dns \
      at_release
    do
      if eval [ \"\$$var\" ]; then
	eval echo export $var=\"\$$var\"
      fi
      true
    done
  ) > "$at_build_dir"/autorun-variables
}

secret() {
  if [ -z "$at_secret" ]; then
    echo No. Root password unchanged.
    return
  fi

  if [ ! -e "$at_lib_release"/mkinit-secret ]; then
    echo Do not know how to change root password for $at_release. >&2
    exit 1
  fi

  echo Changing root password.
  "$at_lib_release"/mkinit-secret
  push_script secret
}


bootstrap() {
  if [ -z "$at_bootstrap" ]; then
    echo No. Bootstrap not requested.
    return
  fi
  echo Installing bootstrap functions.

  puppet_tmpdir=$(mktemp ${at_work_dir:+--tmpdir="$at_work_dir"} -d)
  rsync -a "$at_puppet_dir"/ "$puppet_tmpdir"/puppet/
  if [ "$at_bootstrap" = pm ]; then
    if [ -e "$puppet_tmpdir"/puppet/bootstrap-enc ]; then
      echo bootstrap-enc already exists in $at_puppet_dir. >&2
      echo Using it instead. >&2
    else
      cp "$at_lib"/mkinit-bootstrap-enc "$puppet_tmpdir"/puppet/bootstrap-enc
    fi
    chmod 755 "$puppet_tmpdir"/puppet/bootstrap-enc
  fi

  tar czf "$at_build_dir"/puppet.tgz -C "$puppet_tmpdir" puppet
  chmod +rw -R "$puppet_tmpdir"
  rm -fr "$puppet_tmpdir"
  cp "$at_lib"/autorun-bootstrap "$at_build_dir"/autorun-bootstrap
  push_script bootstrap
}

echo Setting up new host\'s initialiser:
for step in "${steps[@]}"; do
  script=${step%%:*}
  message=${step#*:}
  if [ "$script" != "${script#-}" ]; then
    echo $message
    ${script#-}
  else
    if [ -e "$at_lib_release"/mkinit-$script ]; then
      echo $message
      "$at_lib_release"/mkinit-$script
      push_script $script
    else
      echo Not installing step: $message
    fi
  fi
done
echo Host initialiser build complete.

cp "$at_lib"/autorun "$at_build_dir"/autorun

for script in ${scripts[@]}; do
  chmod 755 "$at_build_dir"/autorun-$script
  echo '"$at_top"'/autorun-$script
done >> "$at_build_dir"/autorun
chmod 755 "$at_build_dir"/autorun

append_readme init

create_image init

